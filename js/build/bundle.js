"use strict";!function(){function t(t,{target:e,cancelable:i,detail:n}={}){const o=new CustomEvent(t,{cancelable:i,bubbles:!0,detail:n});return e?e.dispatchEvent(o):document.documentElement.dispatchEvent(o),o}function e(e,{detail:i,cancelable:n=!0}={}){return!t(e,{cancelable:n,detail:i}).defaultPrevented}function i(t){return function(t){return Array.from(t.querySelectorAll("noscript")).forEach((t=>{t.remove()})),t}(t)}function n(t,e){window.location.assign(e)}function o(t){const e=t.target.closest("a[href]:not([target^=_]):not([download])");if(!e)return!1;const i=window.location.host;return!(e.host!==i)&&e}function a(){return(new Date).getTime()}function r(t){return!(function(t){return t.altKey||t.ctrlKey||t.metaKey||t.shiftKey}(t)||t.defaultPrevented||t.target.isContentEditable)}function s({element:t,property:e,timeout:i=3e3}){return new Promise((n=>{const o=setTimeout((()=>r()),i);function a(i){const n=i.target===t,a=i.propertyName===e;n&&a&&(clearTimeout(o),r())}function r(){t.removeEventListener("transitionend",a),n()}t.addEventListener("transitionend",a)}))}class c{constructor({cacheTimeoutInMinutes:t=10,usePrefetch:e=!0,useCache:i=!0}={}){this.started=!1,this.enabled=!1,this.useCache=i,this.visitCache=[],this.cacheTimeoutInMinutes=t,this.currentLocation=window.location.href,this.usePrefetch=e&&function(){var t,e,i;const n=null===(t=navigator.connection)||void 0===t?void 0:t.saveData,o=null===(e=navigator.connection)||void 0===e||null===(i=e.effectiveType)||void 0===i?void 0:i.includes("2g");return!(n||o)}(),this.prefetchedLocations=new Set,this.prefetchedLocations.add(this.currentLocation),this.elementAttrs={container:"data-page-container",newContainer:"data-page-new",transitionIn:"data-page-in",transitionOut:"data-page-out",track:"data-page-track",noCache:"data-page-no-cache",forbidLoad:"data-page-no-load",forbidPrefetch:"data-page-no-prefetch"},this.trackedAssets=[],this.handleClick=this.handleClick.bind(this),this.handlePrefetchEvent=this.handlePrefetchEvent.bind(this),this.popStateRouter=this.popStateRouter.bind(this)}enable(){this.enabled=!0}disable(){this.enabled=!1}isEnabled(){return this.enabled}cacheIsEnabled(){return this.useCache}clearCache(){this.visitCache=[]}destroy(){this.clearCache(),this.disable(),document.body.removeEventListener("click",this.handleClick,{capture:!0}),this.usePrefetch&&(document.body.removeEventListener("touchstart",this.handleTouchstart,{capture:!0,passive:!0}),document.body.removeEventListener("mousedown",this.handleMousedown,{capture:!0,passive:!0})),window.removeEventListener("popstate",this.popStateRouter)}start(){this.started||(this.startHistory().setTrackedAssets().listenForInteractions().listenForPopState(),this.started=!0,this.enable())}startHistory(){return window.history.replaceState({path:this.currentLocation},"",this.currentLocation),this}setTrackedAssets(){return this.trackedAssets=this.getTrackedAssetsFromDOM(document),this}getTrackedAssetsFromDOM(t){return Array.from(t.querySelectorAll(`[${this.elementAttrs.track}]`)).map((t=>t.src||t.href))}listenForInteractions(){return document.body.addEventListener("click",this.handleClick,{capture:!0}),this.usePrefetch&&(document.body.addEventListener("touchstart",this.handlePrefetchEvent,{capture:!0,passive:!0}),document.body.addEventListener("mousedown",this.handlePrefetchEvent,{capture:!0,passive:!0})),this}listenForPopState(){window.addEventListener("popstate",this.popStateRouter)}handleClick(t){const e=o(t);if(this.clickIsPermissible(t,e)){t.preventDefault();const i=e.href;this.navigate(i)}}clickIsPermissible(t,i){return r(t)&&this.linkIsPermissibleForClick(i)&&e("page-loader:click",{detail:{link:i}})}linkIsPermissibleForClick(t){return t&&!t.hasAttribute(this.elementAttrs.forbidLoad)}handlePrefetchEvent(t){const e=o(t),i=null==e?void 0:e.href;this.prefetchIsPermissible(t,e,i)&&(!function(t){const e=document.createElement("link");e.rel="prefetch",e.href=t,document.head.appendChild(e)}(i),this.prefetchedLocations.add(i))}prefetchIsPermissible(t,i,n){return r(t)&&this.linkIsPermissibleForPrefetch(i)&&this.locationIsPermissibleForPrefetch(n)&&e("page-loader:before-prefetch",{detail:{location:n}})}linkIsPermissibleForPrefetch(t){const e="https:"===(null==t?void 0:t.protocol),i=t&&t.hasAttribute(this.elementAttrs.forbidPrefetch),n=(null==t?void 0:t.pathname)===window.location.pathname,o=null==t?void 0:t.search;return t&&e&&!i&&!n&&!o}locationIsPermissibleForPrefetch(t){return t&&!this.prefetchedLocations.has(t)}popStateRouter(){var t;const e=null===(t=window.history.state)||void 0===t?void 0:t.path;this.isEnabled()&&e?this.navigate(e,{fromPopState:!0}):n(0,e)}async navigate(t,{fromPopState:e=!1}={}){if(this.navigationIsPermissible(t,{fromPopState:e})){this.disable(),this.organizeCache();try{const i=await this.getVisit(t);this.loadIsPermissible(i,{fromPopState:e})&&(this.cacheCurrentPage(),await this.swapContent(i),this.updatePageState(i,{fromPopState:e}),this.enable())}catch(e){n(0,t)}}}navigationIsPermissible(t,{fromPopState:i=!1}={}){return this.isEnabled()&&e("page-loader:before-navigation",{detail:{location:t},cancelable:!i})}organizeCache(){this.removeStaleVisitsFromCache(),this.flagVisitsAsCached()}removeStaleVisitsFromCache(){this.visitCache=this.visitCache.filter((t=>this.isVisitFresh(t.timestamp)))}isVisitFresh(t){return a()-t<this.cacheTimeoutInMilliseconds()}cacheTimeoutInMilliseconds(){return 60*this.cacheTimeoutInMinutes*1e3}flagVisitsAsCached(){this.visitCache.forEach((t=>{t.loadedFromCache=!0}))}async getVisit(t){const e=this.findCachedVisitFromLocation(t);if(e)return e;return await this.createVisit(t)}findCachedVisitFromLocation(t){return this.visitCache.find((e=>e.location===t))}async createVisit(t){const e=await this.fetchNewDOM(t);if(this.trackedAssetsHaveChanged(await e))throw new Error("Tracked assets have changed");const i={location:t,dom:await e,title:await e.title,scrollPosition:0,timestamp:a(),loadedFromCache:!1};return this.addVisitToCache(i),this.prefetchedLocations.add(t),i}async fetchNewDOM(t){const e=await async function(t,e){const{timeout:i=8e3}=e,n=new AbortController,o=setTimeout((()=>n.abort()),i),a=await fetch(t,{...e,signal:n.signal});return clearTimeout(o),a}(t,{timeout:8e3,method:"GET",credentials:"same-origin",headers:{Accept:"text/html, application/xhtml+xml"}});if(await!e.ok)throw new Error("Network error");return i(function(t){const e=(new DOMParser).parseFromString(t,"text/html");if(!e)throw new Error("DOM could not be parsed");return e}(await e.text()))}trackedAssetsHaveChanged(t){const e=this.getTrackedAssetsFromDOM(t),i=e.length!==this.trackedAssets.length,n=e.some((t=>!this.trackedAssets.includes(t)));return i||n}addVisitToCache(t){this.cacheIsEnabled()&&this.visitCache.push(t)}loadIsPermissible(t,{fromPopState:i=!1}={}){return e("page-loader:before-load",{detail:{visit:t},cancelable:!i})}cacheCurrentPage(){if(this.cacheIsEnabled()&&this.currentPageAllowsCaching()&&e("page-loader:before-cache")){const t=i(document.cloneNode(!0)),e=this.findCachedVisitFromLocation(this.currentLocation);e?(e.dom=t,e.scrollPosition=window.scrollY):this.addVisitToCache({location:this.currentLocation,dom:t,title:t.title,scrollPosition:window.scrollY,timestamp:a()})}}currentPageAllowsCaching(){return!this.getPageContainerFromDOM(document.body,this.elementAttrs.noCache)}getPageContainerFromDOM(t,e=!1){const i=`[${this.elementAttrs.container}]`,n=e?`${i}[${e}]`:i;return t.querySelector(`${n}`)}async swapContent(t){var e;const i=this.getPageContainerFromDOM(document.body),n=null===(e=this.getPageContainerFromDOM(t.dom))||void 0===e?void 0:e.cloneNode(!0);if(!i)throw new Error("Old content not found");if(!n)throw new Error("New content not found");this.addNewContentToPage(n),await this.transitionOutOldContent(i),i.remove(),await this.transitionInNewContent(n)}addNewContentToPage(t){t.setAttribute(this.elementAttrs.newContainer,""),document.body.appendChild(t)}async transitionOutOldContent(t){t.removeAttribute(this.elementAttrs.transitionIn),t.setAttribute(this.elementAttrs.transitionOut,""),await s({element:t,property:"opacity",timeout:3e3})}async transitionInNewContent(t){t.removeAttribute(this.elementAttrs.newContainer),t.setAttribute(this.elementAttrs.transitionIn,""),await s({element:t,property:"opacity",timeout:3e3}),t.removeAttribute(this.elementAttrs.transitionIn)}updatePageState(e,{fromPopState:i=!1}){var n,o;i||((n=e.location)===window.location.href||window.history.pushState({path:n},"",n)),o=e.title,document.title=o,this.setCurrentLocation(),function({x:t=0,y:e=0}){window.scrollTo(t,e)}({y:i?e.scrollPosition:0}),t("page-loader:load",{cancelable:!1,detail:{visit:e}})}setCurrentLocation(){this.currentLocation=window.location.href}}const d=function(){let t=!1;const e="data-loading";function i(){document.body.setAttribute(e,"")}function n(){document.body.removeAttribute(e)}return{init:function(){t=new c,t.start(),document.addEventListener("page-loader:before-navigation",i),document.addEventListener("page-loader:load",n)},destroy:function(){t&&t.destroy(),document.removeEventListener("page-loader:before-navigation",i),document.removeEventListener("page-loader:load",n)}}}(),h=function(){function t(t){}function e(t){}function i(t){}function n(t){}function o(t){}function a(t){}return{init:function(){document.addEventListener("page-loader:before-prefetch",t),document.addEventListener("page-loader:click",e),document.addEventListener("page-loader:before-navigation",i),document.addEventListener("page-loader:before-load",n),document.addEventListener("page-loader:before-cache",o),document.addEventListener("page-loader:load",a)}}}();d.init(),h.init()}();